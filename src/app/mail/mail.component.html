<section class="section" id="neem-deel">
  <div class="container">
    <div class="clients-inner section-inner">
      <div class="container">
        <div class="smaller">
          <!-- <ul class="list-reset mb-0"> </ul> -->

          <div fxLayout="row" fxLayout.xs="column" fxLayoutGap="20px">
            <div fxFlex="70" fxFlex.xs="100" *ngIf="!sent">
              <h3 class="section-title mt-0">{{ 'Mail your representatives' | translate }}</h3>

              <div class="who" *ngIf="!selectionComplete">
                <h4>{{ 'Who do you want to mail?' | translate }}</h4>

                <!-- <div class="choice-list" *ngIf="!selectType">
                  <button mat-raised-button color="primary" (click)="selectType = 'filters'">Selectie op kieskring, naam of partij</button>
                  <button mat-raised-button color="primary" (click)="selectType = 'region'">Op basis van locatie</button>
                </div> -->

                <div class="filters">
                  <div fxLayout fxLayoutGap="12px">
                    <mat-form-field fxFlex="50">
                      <mat-label>{{ 'Constituency' | translate }}</mat-label>
                      <mat-select [(ngModel)]="selectedConstituency" name="selectedConstituency" (selectionChange)="filterMps()">
                        <mat-option [value]=""></mat-option>
                        <mat-option *ngFor="let constituency of constituencies" [value]="constituency">
                          {{ constituency }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field fxFlex="50">
                      <mat-label>{{ 'Party' | translate }}</mat-label>
                      <mat-select [(ngModel)]="selectedParty" name="selectedParty" (selectionChange)="filterMps()">
                        <mat-option [value]=""></mat-option>
                        <mat-option *ngFor="let party of parties" [value]="party">
                          {{ party }}
                        </mat-option>
                        <mat-option value="ONAFH">{{ 'Independent' | translate }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <div fxLayout fxLayoutGap="12px">
                    <mat-form-field fxFlex="100">
                      <mat-label>{{ 'Name' | translate }}</mat-label>
                      <input matInput name="nameFilter" [(ngModel)]="nameFilter" (keyup)="filterMps()" />
                    </mat-form-field>
                  </div>
                </div>

                <div class="action-list">
                  <button mat-raised-button *ngIf="(selectedMps.length > 0) || selectionFilterSet" color="primary"
                    (click)="confirmSelection()" [disabled]="selectedMps.length === 0">
                    {{ 'Selection OK' | translate }}
                    <ng-container *ngIf="selectedMps.length > 0">({{ selectedMps.length }})</ng-container>
                  </button>
                  <button mat-raised-button *ngIf="(selectedMps.length > 0) || selectionFilterSet" (click)="clearSelected()"
                    [disabled]="selectedMps.length === 0">{{ 'Clear selection' | translate }}</button>
                  <button mat-raised-button *ngIf="selectionFilterSet" (click)="selectAllVisibleFiltered()" style="float: right">
                    {{ 'Select all' | translate }}</button>
                </div>

                <div class="mp-list" style="margin-bottom: 12px" *ngIf="selectionFilterSet">
                  <app-mp *ngFor="let mp of filteredMps" [mp]="mp" class="mp-card" (mpSelected)="mpSelected($event)"
                    (mpDeselected)="mpDeselected($event)"></app-mp>
                </div>
              </div>

              <form #personalDataForm="ngForm" *ngIf="selectionComplete && selectedMps.length > 0 && !personalDataComplete"
                fxLayout="column" fxLayoutGap="12px">
                <div fxFlex fxLayout="row" fxLayoutGap="12px">
                  <mat-form-field fxFlex="40">
                    <mat-label>{{ 'First name' | translate }}</mat-label>
                    <input matInput name="firstName" [(ngModel)]="newMail.firstName" required>
                  </mat-form-field>

                  <mat-form-field fxFlex="60">
                    <mat-label>{{ 'Last name' | translate }}</mat-label>
                    <input matInput name="lastName" [(ngModel)]="newMail.lastName" required>
                  </mat-form-field>
                </div>

                <mat-form-field fxFlex>
                  <mat-label>{{ 'Email' | translate }}</mat-label>
                  <input matInput placeholder="{{ 'exampleEmail' | translate }}" name="email" [(ngModel)]="newMail.email" required>
                </mat-form-field>

                <div fxFlex fxLayout="row" fxLayoutGap="12px">
                  <mat-form-field fxFlex="30">
                    <mat-label>{{ 'Postal code' | translate }}</mat-label>
                    <input matInput placeholder="1000" name="postalCode" [(ngModel)]="newMail.postalCode" required>
                  </mat-form-field>

                  <mat-form-field fxFlex="70">
                    <mat-label>{{ 'City' | translate }}</mat-label>
                    <input matInput placeholder="{{ 'Brussels' | translate }}" name="city" [(ngModel)]="newMail.city" required>
                  </mat-form-field>
                </div>

                <button mat-raised-button color="primary" [disabled]="!personalDataForm.valid" (click)="personalDataComplete = true;">
                  {{ 'OK - Almost there!' | translate }}</button>
              </form>

              <div *ngIf="personalDataComplete" fxLayout="column" fxLayoutGap="12px">
                <div>
                  <strong>{{ 'To' | translate }}: </strong>
                  <span *ngIf="(selectedMps.length <= 5 || selectedMpListExpanded)" class="mpSelectionList">
                    <span *ngFor="let selectedMp of selectedMps">{{ selectedMp.name }}</span>
                  </span>
                  <span *ngIf="selectedMps.length > 5">
                    <ng-container *ngIf="!selectedMpListExpanded">{{ selectedMps.length }} {{ 'representatives' | translate }}</ng-container> (<a
                      [routerLink]=""
                      (click)="selectedMpListExpanded = !selectedMpListExpanded">{{ selectedMpListExpanded ? ('hide' | translate) : ('show' | translate) }}</a>)
                  </span>
                  <span> (<a [routerLink]="" (click)="selectionComplete = false; personalDataComplete = false;">{{ 'change' | translate }}</a>)</span>
                </div>
                <div>
                  <strong>{{ 'From' | translate }}: </strong> {{ newMail.firstName }} {{ newMail.lastName}} (<a [routerLink]=""
                    (click)="personalDataComplete = false;">wijzig</a>)
                </div>

                <mat-form-field fxFlex *ngIf="customSubject">
                  <mat-label>{{ 'Subject' | translate }}</mat-label>
                  <input matInput placeholder="{{ 'customSubjectPlaceholder' | translate }}" name="customSubject"
                    [(ngModel)]="newMail.subject" #customSubject>
                </mat-form-field>

                <mat-form-field fxFlex *ngIf="!customSubject">
                  <mat-label>{{ 'Subject' | translate }}</mat-label>
                  <mat-select [(ngModel)]="newMail.subject" name="predefinedSubject" (selectionChange)="subjectChanged()">
                    <mat-option *ngFor="let subject of subjects" [value]="subject">
                      {{ subject }}
                    </mat-option>
                    <mat-option [value]="" style="font-style: italic;">{{ 'Write a subject yourself' | translate }}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field fxFlex>
                  <mat-label>{{ 'text' | translate }}</mat-label>
                  <textarea matInput rows="10" placeholder="Leg uit waarom je dit belangrijk vindt." name="body"
                    [(ngModel)]="newMail.body"></textarea>
                  <mat-hint align="start"><strong>{{ 'We provide the opening and closure lines' | translate }}</strong> </mat-hint>
                </mat-form-field>

                <div>
                  <mat-checkbox name="allowPublic" [(ngModel)]="newMail.allowPublic">{{'allowPublic' | translate }}</mat-checkbox>
                </div>

                <!-- <div><mat-checkbox name="allowReplies" [(ngModel)]="newMail.allowReplies">Ik mail onder mijn eigen naam; dit laat toe dat mijn contactpersonen mij persoonlijk kunnen terugmailen.</mat-checkbox></div> -->

                <div>
                  <mat-checkbox name="stayUpToDate" [(ngModel)]="newMail.stayUpToDate">{{ 'stayUpToDate' | translate }}</mat-checkbox>
                </div>

                <button mat-raised-button color="primary" *ngIf="!newMail._id" (click)="sendMail()">{{ 'Send' | translate }}!</button>
              </div>
            </div>

            <div fxFlex="70" fxFlex.xs="100" *ngIf="sent">
              <h3 class="section-title mt-0">{{ 'Thanks' | translate }}!</h3>
              <p>{{ 'representativesMailed' | translate }}</p>
              <p *ngIf="newMail.stayUpToDate">{{ 'weWillKeepYouUpToDate' | translate }}</p>
            </div>

            <div fxFlex="30" fxFlex.xs="100">
              <strong>Namen recent deel...</strong>
              <ul>
                <li *ngFor="let mail of mails">
                  {{ mail.firstName }} {{ mail.lastName.charAt(0).toUpperCase() }}. <span *ngIf="mail.city">({{ mail.city }})</span>
                </li>
              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</section>
